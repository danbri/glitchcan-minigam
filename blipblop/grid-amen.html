<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Bass Sequencer + Amen Break</title>
    <style>
        :root {
            --bg-color: #120458;
            --primary-glow: #ff00a0;
            --secondary-glow: #2de2e6;
            --dark-accent: #0d033d;
            --light-text: #eeeeee;
            --button-text: #120458;
            --monospace-font: 'Courier New', Courier, monospace;
            --sans-serif-font: 'Arial', sans-serif;
            --amen-glow: #00ff00;
        }

        body {
            font-family: var(--sans-serif-font);
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--bg-color);
            color: var(--primary-glow);
            padding: 15px;
            margin: 0;
            overscroll-behavior: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        h1 {
            font-size: 1.8em;
            font-weight: bold;
            text-shadow: 0 0 6px var(--primary-glow), 0 0 12px var(--primary-glow);
            margin: 20px 0;
            text-align: center;
        }

        #sequencer-container {
            width: fit-content;
            max-width: 100%;
            margin: 20px 0;
            background-color: var(--dark-accent);
            padding: 8px;
            border: 1px solid var(--primary-glow);
            border-radius: 6px;
            box-shadow: 0 0 15px rgba(255, 0, 160, 0.3);
        }

        #sequencer {
            display: grid;
            gap: 4px;
            position: relative;
        }

        .row-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            min-width: 35px;
            color: var(--primary-glow);
            font-size: 0.9em;
            padding-right: 5px;
        }

        .note {
            width: 32px;
            height: 32px;
            border: 1px solid var(--primary-glow);
            cursor: pointer;
            transition: opacity 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;
            border-radius: 4px;
            position: relative;
            background-color: rgba(255, 255, 255, 0.05);
        }

        .note.active {
            box-shadow: 0 0 8px currentColor, 0 0 15px currentColor;
            transform: scale(1.03);
            border-width: 2px;
        }

        .note.playing {
            box-shadow: 0 0 10px #ffffff, 0 0 20px #ffffff !important;
            border: 2px solid #ffffff !important;
            opacity: 1 !important;
            transform: scale(1.06);
        }

        .vertical-highlight {
            position: absolute;
            top: 8px;
            bottom: 8px;
            width: calc(32px + 4px);
            background-color: rgba(45, 226, 230, 0.35);
            pointer-events: none;
            transition: left 0.05s linear;
            z-index: 3;
            border-radius: 3px;
            left: -100px;
            display: none;
        }
        body.playing .vertical-highlight {
            display: block;
        }

        #controls {
            margin: 15px 0;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: bold;
            background-color: var(--secondary-glow);
            border: none;
            color: var(--button-text);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 5px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2), 0 0 8px rgba(45, 226, 230, 0.5);
            min-width: 100px;
            text-align: center;
        }
        button:hover {
            background-color: var(--primary-glow);
            color: var(--light-text);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3), 0 0 15px var(--primary-glow);
        }
        button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 0 5px var(--primary-glow);
        }

        /* Amen Break button styling */
        #togglePatternButton.patternAmen {
            background-color: var(--amen-glow);
            color: #1a1a1a;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2), 0 0 8px rgba(0, 255, 0, 0.5);
        }
        #togglePatternButton.patternAmen:hover {
            background-color: #00dd00;
            color: #1a1a1a;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3), 0 0 15px #00dd00;
        }

        #togglePatternButton.patternB {
            background-color: #ff80ed;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2), 0 0 8px rgba(255, 128, 237, 0.5);
        }
        #togglePatternButton.patternB:hover {
            background-color: #f757e1;
            color: var(--light-text);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3), 0 0 15px #f757e1;
        }

        #log-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 95%;
            max-width: 400px;
            margin-top: 15px;
            gap: 10px;
        }

        #activity-stream, #console-log {
            width: 100%;
            height: 60px;
            overflow-y: scroll;
            border: 1px solid var(--primary-glow);
            padding: 8px;
            background-color: rgba(18, 4, 88, 0.75);
            font-size: 0.8em;
            border-radius: 4px;
            color: var(--light-text);
            box-sizing: border-box;
        }

        #console-log {
            color: var(--secondary-glow);
            font-family: var(--monospace-font);
        }
    </style>
</head>
<body>

    <h1>Bass Sequencer + Amen Break</h1>

    <div id="sequencer-container">
        <div id="sequencer">
            <!-- Grid elements generated here -->
        </div>
    </div>

    <div id="controls">
      <button id="playPause">Play</button>
      <button id="togglePatternButton">Bass A</button>
    </div>

    <div id="log-container">
        <div id="activity-stream">Activity Log Initialized...</div>
        <div id="console-log">Console Log Initialized...</div>
    </div>

    <script>
        let audioContext;
        
        // Enhanced notes array - bass notes + drum sounds
        const notes = [
            // Bass notes (E2 to F3)
            { index: 0, name: 'E2',   freq: 82.41,  key: 'E2', color: '#4575b4', voice: 'sawtooth', type: 'bass' },
            { index: 1, name: 'G2',   freq: 98.00,  key: 'G2', color: '#7d0abf', voice: 'sawtooth', type: 'bass' },
            { index: 2, name: 'A2',   freq: 110.00, key: 'A2', color: '#d73027', voice: 'sawtooth', type: 'bass' },
            { index: 3, name: 'B2',   freq: 123.47, key: 'B2', color: '#2477db', voice: 'sawtooth', type: 'bass' },
            { index: 4, name: 'C3',   freq: 130.81, key: 'C3', color: '#7d0abf', voice: 'sawtooth', type: 'bass' },
            { index: 5, name: 'D3',   freq: 146.83, key: 'D3', color: '#1a9850', voice: 'sawtooth', type: 'bass' },
            { index: 6, name: 'E3',   freq: 164.81, key: 'E3', color: '#fee08b', voice: 'sawtooth', type: 'bass' },
            { index: 7, name: 'F3',   freq: 174.61, key: 'F3', color: '#FF69B4', voice: 'sawtooth', type: 'bass' },
            // Drum sounds for Amen Break
            { index: 8, name: 'KICK', freq: 60,     key: 'C1', color: '#ff4444', voice: 'kick',     type: 'drum' },
            { index: 9, name: 'SNARE',freq: 200,    key: 'D1', color: '#44ff44', voice: 'snare',   type: 'drum' },
            { index: 10,name: 'HIHAT',freq: 8000,   key: 'F1', color: '#4444ff', voice: 'hihat',   type: 'drum' }
        ];

        const steps = 16; // Increased to 16 steps for proper Amen Break
        let isPlaying = false;
        let currentStep = 0;
        let intervalId = null;
        let stepDuration = 0.125; // Faster for 16th notes (was 0.25 for 8th notes)

        const sequencer = document.getElementById('sequencer');
        const playPauseBtn = document.getElementById('playPause');
        const togglePatternBtn = document.getElementById('togglePatternButton');
        const activityStream = document.getElementById('activity-stream');
        const consoleElement = document.getElementById('console-log');

        // --- Grid Data for All Patterns ---
        const gridA = notes.map(() => Array(steps).fill(false)); // Bass Pattern A
        const gridB = notes.map(() => Array(steps).fill(false)); // Bass Pattern B  
        const gridAmen = notes.map(() => Array(steps).fill(false)); // Amen Break Pattern

        // Initialize Bass Pattern A (extended to 16 steps)
        gridA[0][0] = true; gridA[0][1] = true; gridA[0][8] = true; gridA[0][9] = true; // E2
        gridA[1][2] = true; gridA[1][3] = true; gridA[1][10] = true; gridA[1][11] = true; // G2
        gridA[5][4] = true; gridA[5][5] = true; gridA[5][12] = true; gridA[5][13] = true; // D3
        gridA[2][6] = true; gridA[2][7] = true; gridA[2][14] = true; gridA[2][15] = true; // A2

        // Initialize Bass Pattern B (extended to 16 steps)
        gridB[0][0] = true; gridB[0][4] = true; gridB[0][8] = true; gridB[0][12] = true; // E2
        gridB[3][2] = true; gridB[3][6] = true; gridB[3][10] = true; gridB[3][14] = true; // B2
        gridB[1][3] = true; gridB[1][7] = true; gridB[1][11] = true; gridB[1][15] = true; // G2

        // Initialize Amen Break Pattern (famous breakbeat)
        // Kick pattern
        gridAmen[8][0] = true;  // Step 1
        gridAmen[8][6] = true;  // Step 7
        gridAmen[8][9] = true;  // Step 10

        // Snare pattern  
        gridAmen[9][4] = true;  // Step 5
        gridAmen[9][12] = true; // Step 13
        gridAmen[9][14] = true; // Step 15

        // Hi-hat pattern (16th notes with some variations)
        for(let i = 0; i < 16; i++) {
            if(i !== 4 && i !== 12 && i !== 14) { // Skip snare hits
                gridAmen[10][i] = true;
            }
        }

        let activePattern = 'A'; // Start with Bass Pattern A

        // --- Enhanced Web Audio Functions ---
        
        function initAudioContext() {
             if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    consoleLog('Audio context initialized.');
                    if (audioContext.state === 'suspended') {
                         audioContext.resume().then(() => { consoleLog('Audio context resumed successfully on init.'); })
                         .catch(e => consoleLog(`Context suspended, needs interaction to resume.`));
                    }
                } catch (e) { consoleError('Web Audio API not supported.'); alert('Web Audio API not supported.'); return false; }
            } else if (audioContext.state === 'suspended') { consoleLog(`Context suspended, needs interaction to resume.`); }
            return true;
        }

        // Enhanced playNote function with drum sounds
        function playNote(noteData, duration = stepDuration * 0.9) {
            if (!audioContext || audioContext.state !== 'running') {
                consoleError(`PlayNote called but context not running (State: ${audioContext ? audioContext.state : 'null'})`);
                 if(audioContext && audioContext.state === 'suspended'){ audioContext.resume().catch(e => consoleError('Silent resume failed in playNote')); }
                return;
            }
            
            const now = audioContext.currentTime;
            
            if (noteData.voice === 'kick') {
                playKick(now, duration);
            } else if (noteData.voice === 'snare') {
                playSnare(now, duration);
            } else if (noteData.voice === 'hihat') {
                playHiHat(now, duration);
            } else {
                // Original bass note synthesis
                const oscType = noteData.voice || 'sawtooth'; 
                const filterFreq = 350; 
                const filterQ = 1.0; 
                const attackTime = 0.02; 
                const sustainLevel = 0.4; 
                const releaseTime = 0.18;
                const effectiveSustainDuration = Math.max(0.01, duration - attackTime);
                
                const oscillator = audioContext.createOscillator(); 
                const filter = audioContext.createBiquadFilter(); 
                const gainNode = audioContext.createGain();
                
                oscillator.type = oscType; 
                oscillator.frequency.setValueAtTime(noteData.freq, now);
                filter.type = 'lowpass'; 
                filter.frequency.setValueAtTime(filterFreq, now); 
                filter.Q.setValueAtTime(filterQ, now);
                gainNode.gain.setValueAtTime(0, now); 
                gainNode.gain.linearRampToValueAtTime(sustainLevel, now + attackTime);
                const releaseStartTime = now + effectiveSustainDuration;
                gainNode.gain.setValueAtTime(sustainLevel, releaseStartTime); 
                gainNode.gain.linearRampToValueAtTime(0.0001, releaseStartTime + releaseTime);
                
                oscillator.connect(filter); 
                filter.connect(gainNode); 
                gainNode.connect(audioContext.destination);
                oscillator.start(now); 
                oscillator.stop(releaseStartTime + releaseTime + 0.05);
            }
        }

        // Drum sound synthesis functions
        function playKick(startTime, duration) {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(60, startTime);
            osc.frequency.exponentialRampToValueAtTime(0.01, startTime + 0.5);
            
            gain.gain.setValueAtTime(0, startTime);
            gain.gain.linearRampToValueAtTime(1, startTime + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.5);
            
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start(startTime);
            osc.stop(startTime + 0.5);
        }

        function playSnare(startTime, duration) {
            const noise = audioContext.createBufferSource();
            const noiseBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.1, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            
            for (let i = 0; i < noiseBuffer.length; i++) {
                output[i] = Math.random() * 2 - 1;
            }
            
            noise.buffer = noiseBuffer;
            
            const noiseGain = audioContext.createGain();
            noiseGain.gain.setValueAtTime(0, startTime);
            noiseGain.gain.linearRampToValueAtTime(0.5, startTime + 0.01);
            noiseGain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.1);
            
            noise.connect(noiseGain);
            noiseGain.connect(audioContext.destination);
            noise.start(startTime);
        }

        function playHiHat(startTime, duration) {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();
            
            osc.type = 'square';
            osc.frequency.setValueAtTime(10000, startTime);
            
            filter.type = 'highpass';
            filter.frequency.setValueAtTime(7000, startTime);
            
            gain.gain.setValueAtTime(0, startTime);
            gain.gain.linearRampToValueAtTime(0.1, startTime + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.1);
            
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioContext.destination);
            osc.start(startTime);
            osc.stop(startTime + 0.1);
        }

        // --- UI and Sequencer Logic ---

        function createSequencer() {
            sequencer.innerHTML = '';
            sequencer.style.gridTemplateColumns = `auto repeat(${steps}, 1fr)`;

            // Determine which notes to show based on active pattern
            const notesToShow = activePattern === 'Amen' ? 
                notes.filter(n => n.type === 'drum') : 
                notes.filter(n => n.type === 'bass');

            notesToShow.forEach((noteData) => {
                const rowLabel = document.createElement('div');
                rowLabel.className = 'row-label';
                rowLabel.textContent = noteData.name;
                sequencer.appendChild(rowLabel);

                for (let col = 0; col < steps; col++) {
                    const noteElement = document.createElement('div');
                    noteElement.className = 'note';
                    noteElement.dataset.row = noteData.index;
                    noteElement.dataset.col = col;
                    noteElement.style.setProperty('--note-color', noteData.color);
                    noteElement.style.backgroundColor = noteData.color;

                    noteElement.addEventListener('click', toggleNote);
                    noteElement.addEventListener('touchstart', (e) => { e.preventDefault(); toggleNote(e); }, { passive: false });
                    sequencer.appendChild(noteElement);
                }
            });

            const verticalHighlight = document.createElement('div');
            verticalHighlight.className = 'vertical-highlight';
            sequencer.appendChild(verticalHighlight);

            updateGridVisuals();
            consoleLog(`Sequencer grid created. Active pattern: ${activePattern}`);
        }

        function updateGridVisuals() {
            const currentGrid = activePattern === 'A' ? gridA : 
                               activePattern === 'B' ? gridB : gridAmen;
            const noteElements = sequencer.querySelectorAll('.note');

            noteElements.forEach(noteElement => {
                const row = parseInt(noteElement.dataset.row, 10);
                const col = parseInt(noteElement.dataset.col, 10);
                const isActive = currentGrid[row] && currentGrid[row][col];

                noteElement.style.opacity = isActive ? '1' : '0.35';
                noteElement.classList.toggle('active', isActive);
            });
            consoleLog(`Grid visuals updated to Pattern ${activePattern}`);
        }

        function toggleNote(event) {
             if (!initAudioContext()) return;
             if(audioContext.state === 'suspended'){
                 audioContext.resume().then(()=>{ consoleLog('Audio resumed on note toggle.'); _performToggle(event); })
                 .catch(e => consoleError('Failed to resume audio on toggle.'));
                 return;
             }
             _performToggle(event);
        }

        function _performToggle(event) {
            const target = event.target;
            if (!target.classList.contains('note')) return;

            const row = parseInt(target.dataset.row, 10);
            const col = parseInt(target.dataset.col, 10);
            if (isNaN(row) || isNaN(col) || row < 0 || row >= notes.length || col < 0 || col >= steps) {
                 consoleError(`Invalid note coordinates: index=${row}, col=${col}`); return;
            }

            const targetGrid = activePattern === 'A' ? gridA : 
                             activePattern === 'B' ? gridB : gridAmen;

            targetGrid[row][col] = !targetGrid[row][col];

            target.style.opacity = targetGrid[row][col] ? '1' : '0.35';
            target.classList.toggle('active', targetGrid[row][col]);

            if (targetGrid[row][col]) {
                const noteToPlay = notes.find(n => n.index === row);
                if(noteToPlay) { playNote(noteToPlay, 0.15); }
            }

            const noteName = notes.find(n => n.index === row)?.name || `Row ${row}`;
            logActivity(`Pattern ${activePattern}: Toggled ${noteName} [Col ${col}] to ${targetGrid[row][col] ? 'ON' : 'OFF'}`);
        }

        function togglePattern() {
            // Cycle through: A -> B -> Amen -> A
            if (activePattern === 'A') {
                activePattern = 'B';
            } else if (activePattern === 'B') {
                activePattern = 'Amen';
            } else {
                activePattern = 'A';
            }
            
            const buttonText = activePattern === 'Amen' ? 'AMEN BREAK' : `Bass ${activePattern}`;
            togglePatternBtn.textContent = buttonText;
            
            // Update button styling
            togglePatternBtn.classList.remove('patternB', 'patternAmen');
            if (activePattern === 'B') {
                togglePatternBtn.classList.add('patternB');
            } else if (activePattern === 'Amen') {
                togglePatternBtn.classList.add('patternAmen');
            }
            
            // Recreate the grid to show appropriate instruments
            createSequencer();
            logActivity(`Switched to Pattern ${activePattern}`);
        }

        function logActivity(message) {
            const logEntry = document.createElement('div');
            const time = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'});
            logEntry.textContent = `[${time}] ${message}`;
            activityStream.insertBefore(logEntry, activityStream.firstChild);
            if (activityStream.childNodes.length > 30) { activityStream.removeChild(activityStream.lastChild); }
        }
        
        function consoleLog(message) {
            console.log(message);
            const logEntry = document.createElement('div');
            logEntry.textContent = `> ${message}`;
            consoleElement.appendChild(logEntry);
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }
        
        function consoleError(message) {
            console.error(message);
            const logEntry = document.createElement('div');
            logEntry.style.color = '#FF6B6B';
            logEntry.textContent = `> ERROR: ${message}`;
            consoleElement.appendChild(logEntry);
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }

        function step() {
             if (!isPlaying || !audioContext || audioContext.state !== 'running') return;

            const currentGrid = activePattern === 'A' ? gridA : 
                               activePattern === 'B' ? gridB : gridAmen;
            const prevStep = (currentStep - 1 + steps) % steps;

            sequencer.querySelectorAll(`.note[data-col="${prevStep}"]`).forEach(noteEl => { noteEl.classList.remove('playing'); });

            notes.forEach((noteData) => {
                const row = noteData.index;
                const noteElement = sequencer.querySelector(`.note[data-row="${row}"][data-col="${currentStep}"]`);
                if(noteElement) noteElement.classList.add('playing');

                if (currentGrid[row] && currentGrid[row][currentStep]) {
                    playNote(noteData);
                }
            });

            // Move highlight bar
            const verticalHighlight = sequencer.querySelector('.vertical-highlight');
            if (verticalHighlight) {
                 const firstLabel = sequencer.querySelector('.row-label');
                 const firstNote = sequencer.querySelector('.note');
                 if (firstLabel && firstNote) {
                     const labelWidth = parseFloat(getComputedStyle(firstLabel).width);
                     const noteWidth = parseFloat(getComputedStyle(firstNote).width);
                     const gap = parseFloat(getComputedStyle(sequencer).gap);
                     const highlightLeft = labelWidth + 8 + 5 + currentStep * (noteWidth + gap);
                     verticalHighlight.style.left = `${highlightLeft}px`;
                 }
            }

            currentStep = (currentStep + 1) % steps;
        }

        function togglePlayPause() {
            if (!initAudioContext()) { alert("Could not initialize audio..."); return; }
             if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                     consoleLog('Audio context resumed on play toggle.');
                     if (isPlaying) { stopPlayback(); } else { startPlayback(); }
                }).catch(e => { consoleError(`Failed to resume audio context on play toggle: ${e}`); alert("Audio couldn't start..."); });
             } else {
                 if (isPlaying) { stopPlayback(); } else { startPlayback(); }
             }
        }

        function startPlayback() {
            if (isPlaying || !audioContext || audioContext.state !== 'running') return;
            currentStep = 0;
             document.body.classList.add('playing');
             step();
            intervalId = setInterval(step, stepDuration * 1000);
            playPauseBtn.textContent = 'Pause';
            isPlaying = true;
            logActivity('Sequencer Started');
            consoleLog('Playback started.');
        }

        function stopPlayback() {
             if (!isPlaying) return;
            clearInterval(intervalId);
            intervalId = null;
             document.body.classList.remove('playing');
             sequencer.querySelectorAll(`.note.playing`).forEach(noteEl => { noteEl.classList.remove('playing'); });
              const verticalHighlight = sequencer.querySelector('.vertical-highlight');
              if(verticalHighlight) verticalHighlight.style.left = '-100px';
            playPauseBtn.textContent = 'Play';
            isPlaying = false;
            logActivity('Sequencer Stopped');
            consoleLog('Playback stopped.');
        }

        // --- Initialization ---
        createSequencer();
        playPauseBtn.addEventListener('click', togglePlayPause);
        togglePatternBtn.addEventListener('click', togglePattern);

        const initInteractionHandler = () => { initAudioContext(); consoleLog('Initial user interaction detected.'); };
        document.body.addEventListener('click', initInteractionHandler, { once: true });
        document.body.addEventListener('touchstart', initInteractionHandler, { once: true });

        consoleLog('Bass Sequencer + Amen Break initialized.');
        logActivity('App loaded. Interact (tap/click) then Press Play to hear the famous Amen Break!');

    </script>
</body>
</html>