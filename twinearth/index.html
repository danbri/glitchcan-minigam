<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twin Earth</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: Arial, sans-serif;
            color: white;
        }
        
        .controls-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 15px;
            width: 250px;
            transition: transform 0.3s ease;
            transform: translateX(0);
            z-index: 1000;
        }
        
        .controls-panel.collapsed {
            transform: translateX(calc(100% - 40px));
        }
        
        .controls-toggle {
            position: absolute;
            left: 15px;
            top: 15px;
            cursor: pointer;
            font-size: 20px;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
        }
        
        .controls-content {
            margin-left: 25px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 5px;
        }
        
        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .control-label {
            flex: 1;
        }
        
        .control-value {
            width: 40px;
            text-align: right;
            font-size: 12px;
            opacity: 0.8;
        }
        
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 5px;
            border-radius: 5px;
            background: #444;
            outline: none;
            margin: 5px 0;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #6ab0ff;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #6ab0ff;
            cursor: pointer;
        }
        
        .checkbox-control {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .checkbox-control input {
            margin-right: 8px;
        }
        
        button {
            background: #2a5a9e;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            width: 100%;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background: #3a6db1;
        }
        
        .info-footer {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 15px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="controls-panel" id="controls-panel">
        <div class="controls-toggle" id="controls-toggle">â—€</div>
        <div class="controls-content">
            <div class="control-group">
                <h3>Earth Options</h3>
                <div class="checkbox-control">
                    <input type="checkbox" id="twin-toggle">
                    <label for="twin-toggle">Twin Earth Mode</label>
                </div>
                <div class="control-row">
                    <span class="control-label">Rotation Speed</span>
                    <span class="control-value" id="rotation-value">0.5</span>
                </div>
                <input type="range" min="0" max="2" step="0.1" value="0.5" class="slider" id="rotation-slider">
                
                <div class="control-row">
                    <span class="control-label">Bump Strength</span>
                    <span class="control-value" id="bump-value">0.05</span>
                </div>
                <input type="range" min="0" max="0.2" step="0.01" value="0.05" class="slider" id="bump-slider">
            </div>
            
            <div class="control-group">
                <h3>Cloud Options</h3>
                <div class="control-row">
                    <span class="control-label">Cloud Opacity</span>
                    <span class="control-value" id="cloud-opacity-value">0.5</span>
                </div>
                <input type="range" min="0" max="1" step="0.05" value="0.5" class="slider" id="cloud-opacity-slider">
                
                <div class="control-row">
                    <span class="control-label">Cloud Speed</span>
                    <span class="control-value" id="cloud-speed-value">0.7</span>
                </div>
                <input type="range" min="0" max="2" step="0.1" value="0.7" class="slider" id="cloud-speed-slider">
            </div>
            
            <div class="control-group">
                <h3>Lighting</h3>
                <div class="control-row">
                    <span class="control-label">Light Intensity</span>
                    <span class="control-value" id="light-value">1.0</span>
                </div>
                <input type="range" min="0" max="2" step="0.1" value="1.0" class="slider" id="light-slider">
                
                <div class="control-row">
                    <span class="control-label">Night Light Glow</span>
                    <span class="control-value" id="night-value">0.7</span>
                </div>
                <input type="range" min="0" max="1" step="0.05" value="0.7" class="slider" id="night-slider">
            </div>
            
            <button id="reset-button">Reset to Defaults</button>
            
            <div class="info-footer">
                Twin Earth Visualization v1.0
            </div>
        </div>
    </div>

    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
      }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        class TwinEarthComponent extends HTMLElement {
            constructor() {
                super();
                this.isTwinMode = false;
                this.animationId = null;
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.earth = null;
                this.clouds = null;
                this.night = null;
                this.sunLight = null;
                this.textures = {};
                this.controls = null;
                
                // Default values for controls
                this.settings = {
                    rotationSpeed: 0.5,
                    bumpStrength: 0.05,
                    cloudOpacity: 0.5,
                    cloudSpeed: 0.7,
                    lightIntensity: 1.0,
                    nightGlow: 0.7
                };
                
                // Bind methods to maintain this context
                this.onWindowResizeBound = this.onWindowResize.bind(this);
                this.toggleTwinModeBound = this.toggleTwinMode.bind(this);
                this.animateBound = this.animate.bind(this);
            }

            connectedCallback() {
                this.init();
                this.setupEventListeners();
                this.loadTextures();
                this.setupControlPanel();
            }

            disconnectedCallback() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
                window.removeEventListener('resize', this.onWindowResizeBound);
                const toggle = document.getElementById('twin-toggle');
                if (toggle) {
                    toggle.removeEventListener('change', this.toggleTwinModeBound);
                }
            }

            init() {
                // Create scene
                this.scene = new THREE.Scene();

                // Create camera
                this.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.z = 3;

                // Create renderer
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.appendChild(this.renderer.domElement);

                // Add ambient light - slightly brighter for better visibility
                const ambientLight = new THREE.AmbientLight(0x555555);
                this.scene.add(ambientLight);

                // Add directional light (sun)
                this.sunLight = new THREE.DirectionalLight(0xffffff, this.settings.lightIntensity);
                this.sunLight.position.set(5, 3, 5);
                this.scene.add(this.sunLight);

                // Add orbit controls - using imported OrbitControls
                this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                this.controls.rotateSpeed = 0.5;
                
                // Add starfield background
                this.addStarfield();
            }

            addStarfield() {
                const starGeometry = new THREE.BufferGeometry();
                const starMaterial = new THREE.PointsMaterial({
                    color: 0xffffff,
                    size: 0.1,
                });

                const starVertices = [];
                for (let i = 0; i < 10000; i++) {
                    const x = (Math.random() - 0.5) * 2000;
                    const y = (Math.random() - 0.5) * 2000;
                    const z = (Math.random() - 0.5) * 2000;
                    starVertices.push(x, y, z);
                }

                starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
                const stars = new THREE.Points(starGeometry, starMaterial);
                this.scene.add(stars);
            }

            setupEventListeners() {
                window.addEventListener('resize', this.onWindowResizeBound);
                
                const toggle = document.getElementById('twin-toggle');
                toggle.addEventListener('change', this.toggleTwinModeBound);
            }
            
            setupControlPanel() {
                // Toggle control panel
                const controlsPanel = document.getElementById('controls-panel');
                const controlsToggle = document.getElementById('controls-toggle');
                
                controlsToggle.addEventListener('click', () => {
                    controlsPanel.classList.toggle('collapsed');
                    controlsToggle.textContent = controlsPanel.classList.contains('collapsed') ? 'â–¶' : 'â—€';
                });
                
                // Connect sliders to settings
                this.connectSlider('rotation-slider', 'rotation-value', 'rotationSpeed');
                this.connectSlider('bump-slider', 'bump-value', 'bumpStrength', this.updateBumpScale.bind(this));
                this.connectSlider('cloud-opacity-slider', 'cloud-opacity-value', 'cloudOpacity', this.updateCloudOpacity.bind(this));
                this.connectSlider('cloud-speed-slider', 'cloud-speed-value', 'cloudSpeed');
                this.connectSlider('light-slider', 'light-value', 'lightIntensity', this.updateLightIntensity.bind(this));
                this.connectSlider('night-slider', 'night-value', 'nightGlow', this.updateNightGlow.bind(this));
                
                // Reset button
                const resetButton = document.getElementById('reset-button');
                resetButton.addEventListener('click', this.resetToDefaults.bind(this));
            }
            
            connectSlider(sliderId, valueId, settingKey, callback = null) {
                const slider = document.getElementById(sliderId);
                const valueDisplay = document.getElementById(valueId);
                
                if (slider && valueDisplay) {
                    // Initialize with current setting value
                    slider.value = this.settings[settingKey];
                    valueDisplay.textContent = this.settings[settingKey].toFixed(2);
                    
                    // Update on change
                    slider.addEventListener('input', () => {
                        const value = parseFloat(slider.value);
                        this.settings[settingKey] = value;
                        valueDisplay.textContent = value.toFixed(2);
                        
                        // Call the callback if provided
                        if (callback) callback(value);
                    });
                }
            }
            
            resetToDefaults() {
                // Default values
                const defaults = {
                    rotationSpeed: 0.5,
                    bumpStrength: 0.05,
                    cloudOpacity: 0.5,
                    cloudSpeed: 0.7,
                    lightIntensity: 1.0,
                    nightGlow: 0.7
                };
                
                // Reset each setting
                Object.keys(defaults).forEach(key => {
                    this.settings[key] = defaults[key];
                });
                
                // Update UI
                document.getElementById('rotation-slider').value = defaults.rotationSpeed;
                document.getElementById('rotation-value').textContent = defaults.rotationSpeed.toFixed(2);
                
                document.getElementById('bump-slider').value = defaults.bumpStrength;
                document.getElementById('bump-value').textContent = defaults.bumpStrength.toFixed(2);
                this.updateBumpScale(defaults.bumpStrength);
                
                document.getElementById('cloud-opacity-slider').value = defaults.cloudOpacity;
                document.getElementById('cloud-opacity-value').textContent = defaults.cloudOpacity.toFixed(2);
                this.updateCloudOpacity(defaults.cloudOpacity);
                
                document.getElementById('cloud-speed-slider').value = defaults.cloudSpeed;
                document.getElementById('cloud-speed-value').textContent = defaults.cloudSpeed.toFixed(2);
                
                document.getElementById('light-slider').value = defaults.lightIntensity;
                document.getElementById('light-value').textContent = defaults.lightIntensity.toFixed(2);
                this.updateLightIntensity(defaults.lightIntensity);
                
                document.getElementById('night-slider').value = defaults.nightGlow;
                document.getElementById('night-value').textContent = defaults.nightGlow.toFixed(2);
                this.updateNightGlow(defaults.nightGlow);
            }
            
            updateBumpScale(value) {
                if (this.earth && this.earth.material) {
                    this.earth.material.bumpScale = value;
                }
            }
            
            updateCloudOpacity(value) {
                if (this.clouds && this.clouds.material) {
                    this.clouds.material.opacity = value;
                }
            }
            
            updateLightIntensity(value) {
                if (this.sunLight) {
                    this.sunLight.intensity = value;
                }
            }
            
            updateNightGlow(value) {
                if (this.night && this.night.material) {
                    this.night.material.opacity = value;
                }
            }

            onWindowResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }

            toggleTwinMode() {
                const toggle = document.getElementById('twin-toggle');
                this.isTwinMode = toggle.checked;
                this.updateEarthModel();
            }

            loadTextures() {
                const textureLoader = new THREE.TextureLoader();
                const textureFiles = {
                    colorMap: 'color_map.jpg',
                    bumpMap: 'bump.jpg',
                    specMap: 'spec_mask.jpg',
                    nightMap: 'night_lights.jpg',
                    cloudsMap: 'clouds.png'
                };

                // Use Promise.all for better texture loading
                const texturePromises = Object.entries(textureFiles).map(([key, file]) => {
                    return new Promise((resolve, reject) => {
                        textureLoader.load(
                            file,
                            (texture) => {
                                this.textures[key] = texture;
                                resolve();
                            },
                            undefined,
                            (err) => {
                                console.error(`Error loading texture ${file}:`, err);
                                reject(err);
                            }
                        );
                    });
                });

                Promise.all(texturePromises)
                    .then(() => {
                        this.createEarthModel();
                        this.animate();
                    })
                    .catch(err => console.error('Error loading textures:', err));
            }

            createEarthModel() {
                // Create Earth sphere
                const earthGeometry = new THREE.SphereGeometry(1, 64, 64);
                
                // Create Earth material with textures, enhanced color saturation
                const earthMaterial = new THREE.MeshPhongMaterial({
                    map: this.textures.colorMap,
                    bumpMap: this.textures.bumpMap,
                    bumpScale: this.settings.bumpStrength,
                    specularMap: this.textures.specMap,
                    specular: new THREE.Color(0x444444),
                    shininess: 15
                });

                // Create Earth mesh
                this.earth = new THREE.Mesh(earthGeometry, earthMaterial);
                this.scene.add(this.earth);

                // Create clouds layer with reduced opacity for better earth visibility
                const cloudsGeometry = new THREE.SphereGeometry(1.02, 64, 64);
                const cloudsMaterial = new THREE.MeshPhongMaterial({
                    map: this.textures.cloudsMap,
                    transparent: true,
                    opacity: this.settings.cloudOpacity
                });

                this.clouds = new THREE.Mesh(cloudsGeometry, cloudsMaterial);
                this.scene.add(this.clouds);

                // Create night side (using night lights texture)
                const nightGeometry = new THREE.SphereGeometry(0.99, 64, 64);
                const nightMaterial = new THREE.MeshBasicMaterial({
                    map: this.textures.nightMap,
                    blending: THREE.AdditiveBlending,
                    opacity: this.settings.nightGlow,
                    transparent: true
                });
                
                this.night = new THREE.Mesh(nightGeometry, nightMaterial);
                this.scene.add(this.night);

                // Apply initial Earth model settings
                this.updateEarthModel();
            }

            updateEarthModel() {
                if (!this.earth || !this.clouds || !this.night) return;

                // Apply twin earth effect by flipping textures horizontally
                const earthMaterial = this.earth.material;
                const cloudsMaterial = this.clouds.material;
                const nightMaterial = this.night.material;

                // Set texture repeat and offset to flip horizontally
                if (this.isTwinMode) {
                    // Create twin earth by setting repeat.x to -1 and offset.x to 1
                    earthMaterial.map.repeat.set(-1, 1);
                    earthMaterial.map.offset.set(1, 0);
                    
                    earthMaterial.bumpMap.repeat.set(-1, 1);
                    earthMaterial.bumpMap.offset.set(1, 0);
                    
                    earthMaterial.specularMap.repeat.set(-1, 1);
                    earthMaterial.specularMap.offset.set(1, 0);
                    
                    cloudsMaterial.map.repeat.set(-1, 1);
                    cloudsMaterial.map.offset.set(1, 0);
                    
                    nightMaterial.map.repeat.set(-1, 1);
                    nightMaterial.map.offset.set(1, 0);
                } else {
                    // Reset to normal earth
                    earthMaterial.map.repeat.set(1, 1);
                    earthMaterial.map.offset.set(0, 0);
                    
                    earthMaterial.bumpMap.repeat.set(1, 1);
                    earthMaterial.bumpMap.offset.set(0, 0);
                    
                    earthMaterial.specularMap.repeat.set(1, 1);
                    earthMaterial.specularMap.offset.set(0, 0);
                    
                    cloudsMaterial.map.repeat.set(1, 1);
                    cloudsMaterial.map.offset.set(0, 0);
                    
                    nightMaterial.map.repeat.set(1, 1);
                    nightMaterial.map.offset.set(0, 0);
                }

                // Update texture properties
                earthMaterial.map.needsUpdate = true;
                earthMaterial.bumpMap.needsUpdate = true;
                earthMaterial.specularMap.needsUpdate = true;
                cloudsMaterial.map.needsUpdate = true;
                nightMaterial.map.needsUpdate = true;
            }

            animate() {
                this.animationId = requestAnimationFrame(this.animateBound);
                
                // Apply rotation based on control settings
                const baseSpeed = 0.001;
                
                // Rotate earth and clouds slowly
                if (this.earth) {
                    this.earth.rotation.y += baseSpeed * this.settings.rotationSpeed;
                }
                
                if (this.clouds) {
                    this.clouds.rotation.y += baseSpeed * this.settings.cloudSpeed; // Clouds rotate at separate speed
                }
                
                if (this.night) {
                    this.night.rotation.y += baseSpeed * this.settings.rotationSpeed; // Same as Earth
                }
                
                // Update controls
                if (this.controls) {
                    this.controls.update();
                }
                
                // Render scene
                this.renderer.render(this.scene, this.camera);
            }
        }

        // Register the web component
        customElements.define('twin-earth-component', TwinEarthComponent);

        // Create and add the component to the page
        const twinEarth = document.createElement('twin-earth-component');
        document.body.appendChild(twinEarth);
    </script>
</body>
</html>